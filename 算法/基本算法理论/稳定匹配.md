参考：
《算法设计-康奈尔大学》
[经典算法问题——稳定匹配](https://zhuanlan.zhihu.com/p/225925804)

## 1. 问题描述

给出一个 ` n` 个男性的集合 `M` 和 `n` 个女性的集合 `W`，其中：

-   每位男性根据对所有女性的心仪程度从高至低进行排名；
-   每位女性根据对所有男性的心仪程度从高至低进行排名。

根据以上条件，我们需要找到一个“稳定匹配”。

### 1.1 匹配

匹配 `S` 是一个包含有序数对 `m−w` 的集合，其中 $m∈M$ 且 $w∈W$ ，其中：

-   每个男性最多出现在一个数对中；
-   每个女性最多出现在一个数对中。

### 1.2 完全匹配

如果 `|S|=|M|=|W|=n` ，则匹配 `S` 是完美匹配，也就是说，男女数量相等且都有唯一匹配的对象。

### 1.3 不稳定因素

给出一个完美匹配 `S` ，如果其中存在一个男性 `m` 和一个女性 `w` 同时满足下列条件：

-   `m−w` 不在匹配 `S` 中；
-   `m` 比起他当前配偶，更喜欢 `w` ;
-   `w ` 比起她当前配偶，更喜欢 ` m ` 。

则称男性 `m` 和女性 `w` 是不稳定的，也就是说， `(m, w)` 是**不稳定因素**。这里举例说明：
例 1: 假设有两个男人集合 `{m1, m2}`  和两个女人集合 `{w1, w2}`，优先表如下
```
m1 更偏爱 w1 而不爱 w2
m2 更偏爱 w1 而不爱 w2
w1 更偏爱 m1 而不爱 m2
w2 更偏爱 m1 而不爱 m2
```
那么这里存在一个由 `(m1, w1) , (m2, w2)` 对组成的唯一稳定匹配。而另外一组由 `(m1, w2) , (m2, w1)` 组成的完全匹配不是稳定匹配，因为 `(m1, w1)` 对构成了一个不稳定因素。

例 2: 假设上面例子中的优先表如下
```
m1 更偏爱 w1 而不爱 w2
m2 更偏爱 w2 而不爱 w1
w1 更偏爱 m2 而不爱 m1
w2 更偏爱 m1 而不爱 m2
```
那这里就存在由 `(m1, w1) , (m2, w2)` 对组成的匹配是稳定匹配，因为两个男人已经是最满意了，因此没人想要离开他们目前匹配的伴侣。而由 `(m2, w1) , (m1, w2)` 对组成的匹配也是稳定的，因为两个女人已经是最满意的了，也不会离开现有伴侣。

### 1.4 稳定匹配

一个不存在 不稳定因素 的完美匹配。

### 1.5 Gale-Shapley 算法

```
初始所有的 m∈M 和 w∈W 都是自由的，即 S 是空集合
while 存在男人 m 是自由的且还没对每个女人求过婚
	选择这样一个男人 m
	令 w 是 m 的优先表中 m 还没有求过婚的最高排名的女人
	if w 是自由的 then
		(m,w) 变成约会状态
	else w 当前与 m1 约会
		if w 更偏爱 m1 而不爱 m then
			 m 保持自由
		else w 更偏爱 m 而不爱 m1
			(m,w) 变成约会状态
			m1 变成自由状态
		endif
	endif
end while
return 稳定匹配 S
```

简单来说，算法的策略如下：

-   男性策略：单身的男性会主动出击，根据喜好降序向所有女性求婚，直到有配偶为止；
-   女性策略：被动等待男性求婚，如果女性仍处于单身，则直接接受；有配偶的情况下被更心仪的男性求婚，则会抛弃原来的，接受更好的。


**有穷性：算法最多在** $n^2$ **次 `while` 迭代后一定会结束。**

**证明**

`while` 循环中每次男性向一位女性求婚，最多只有 $n^2$ 次求婚。

**完美性：算法中所有男性和女性都匹配完毕。**

**证明（反证法）**

1.  假设：存在男性 $m$ 在算法终止后仍然未匹配到女性
2.  由此可知，一定有一位女性 $w$，也没有匹配到男性
3.  根据算法，一位单身女性一定会同意向她求婚的男性，所以女性 $w$ 一定没有被求过婚
4.  根据算法 `while` 循环条件，因为男性 $m$ 没有配偶，因此他一定会向所有女性求过婚算法才会终止
5.  因此男性 $m$ 向女性 $w$ 求过婚
6.  3 与 5 产生矛盾，假设不成立，证明完毕

**稳定性：算法产生的匹配中，不会有不稳定因素**

**证明**

1.  假设：`GS` 匹配 $S^∗$ 不包含配对 `m-w`（`m` 是一位男性，`w` 是一位女性）
2.  情况 1：`m` 从未向 `w` 求婚
* 1.  因为 `m` 是降序求婚，所以比起  `w`，`m` 更喜欢 `GS` 算法得到的配偶
* 2.  所以 `(m, w)` 不是不稳定因素

3.  情况 2：`m` 向 `w` 求过婚
* 1.  所以 `w` 拒绝了或抛弃了 `m`
* 2.  所以 `w` 更喜欢 `GS` 算法得到的配偶
* 3.  所以 `(m, w)` 不是不稳定因素

4.  根据上文“不稳定因素”的定义，`GS` 匹配不会产生不稳定因素，因此是稳定的

**正当配偶**

定义：如果存在一个稳定匹配中男性 $m$ 和女性 $w$ 匹配在一起，则称女性 $w$ 是男性 $m$ 的正当配偶。

**男性最佳分配**

`GS` 算法中每个男性都能分配到最佳的正当配偶，所以 `GS` 算法得到的分配一定是男性最佳分配。

**证明**

1.  假设：在GS算法得到的匹配 S 中，存在一位男性与一位女性匹配，该女性不是最佳正当配偶
2. 因为男性根据喜好降序求婚
-   所以有男性在 `GS` 算法中被最佳正当配偶拒绝
3. 令男性 `Y` 是第一个这样的男性，同时令女性 `A` 是第一个拒绝他的正当配偶（也就最佳正当配偶）
4. 因此一定存在 `S'` 是一个包含 `Y-A` 的稳定匹配
5. 不妨令在 `GS` 算法得到的稳定匹配 `S` 中，当男性 `Y` 被女性 `A` 拒绝时，女性 `A` 与男性 `Z` 配对
6. 所以，女性 `A` 比起男性 `Y` 更喜欢男性 `Z`
7. 不妨假设在 `S'` 中，女性 `B` 是男性 `Z` 的配偶
8. `GS` 算法中，男性 `Z` 在男性 `Y` 被女性 `A` 拒绝的时候，还没有被任何正当配偶拒绝（因为我们令男性 `Y` 和女性 `A` 是**第一对**这样的男女）
9. 根据 5 和 7 的结论，`Z-A` 和 `Z-B` 都是正当配偶，现在已知在 `S` 中男性 `Z` 与女性 `A` 配对
10. 如果男性 `Z` 在向女性 `A` 求婚时，如果已经向女性 `B` 求过婚，一定被拒绝了，与 8 矛盾
11. 因此，当男性 `Z` 向女性 `A` 求婚时，他还没有向女性 `B` 求过婚
12. 所以，男性 `Z` 比起女性 `B` 更喜欢女性 `A`
13. 根据 6 和 12 的结论，`(Z, A)` 是 `S'` 中的不稳定因素，因此 `S'` 不是稳定匹配，这与 4 的结论矛盾

因此假设不成立，说明 `GS` 算法中所有男性的配偶该都是最佳正当配偶，`GS` 算法是男性最佳策略

**女性最劣分配**

GS 算法中女性一定分配到的是最差的正当配偶。

**证明**

1.  假设： `Z-A` 在 `GS` 算法得到的稳定匹配 `S` 中匹配，但是男性 `Z` 不是女性 `A` 的最差正当配偶
2.  那么，存在稳定匹配 `S'`，其中女性 `A` 与男性 `Y` 配对，且男性 `Y` 是更差的正当配偶
3.  所以女性 `A` 比起男性 `Y` 更喜欢男性 `Z`
4.  在 `S'` 中，令女性 `B` 是男性 `Z` 的配偶，根据 `GS` 算法的男性最优性，女性 `A` 是男性 `Z` 的最佳正当配偶
5.  所以男性 `Z` 比起女性 `B` 更喜欢女性 `A`
6.  因此根据 3 和 5，`(Z, A)` 是 `S'` 中的不稳定因素，所以 `S'` 并不是稳定匹配，与 2 矛盾
7.  因此假设不成立，说明所有女性分配到的男性都是最差正当配偶，`GS` 算法是女性最劣分配。
